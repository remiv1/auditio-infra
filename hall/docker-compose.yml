version: "3.8"

services:
  traefik:
    container_name: hall-traefik
    build:
      context: .
      dockerfile: Dockerfile.traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - traefik-acme:/etc/traefik/acme
    networks:
      - hall-network

  flask:
    container_name: hall-flask
    build:
      context: .
      dockerfile: Dockerfile.flask
    restart: always
    environment:
      - FLASK_ENV=production
      - DATABASE_PATH=/data/hall.db
      - CONFIG_PATH=/app/config/domains.json
      - TESTING_SERVER_IP=${TESTING_SERVER_IP:-}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
    volumes:
      - hall-data:/data
      - ./config:/app/config:ro,Z
    networks:
      - hall-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask.rule=PathPrefix(`/`)"
      - "traefik.http.services.flask.loadbalancer.server.port=5000"

volumes:
  hall-data:
    driver: local
  traefik-acme:
    driver: local

networks:
  hall-network:
    name: hall-network
    driver: bridge
