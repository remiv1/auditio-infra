version: "3.8"

services:
  traefik:
    container_name: hall-traefik
    build:
      context: .
      dockerfile: Dockerfile.traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro,Z
      - ./traefik/dynamic:/etc/traefik/dynamic:ro,Z
      - ./traefik/acme:/etc/traefik/acme:Z
    networks:
      - hall-network

  flask:
    container_name: hall-flask
    build:
      context: .
      dockerfile: Dockerfile.flask
    restart: always
    environment:
      - FLASK_ENV=production
      - DATABASE_PATH=/data/hall.db
      - CONFIG_PATH=/app/config/domains.json
    volumes:
      - hall-data:/data
      - ./config:/app/config:ro,Z
    networks:
      - hall-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask.rule=PathPrefix(`/`)"
      - "traefik.http.services.flask.loadbalancer.server.port=5000"

volumes:
  hall-data:
    driver: local

networks:
  hall-network:
    driver: bridge
